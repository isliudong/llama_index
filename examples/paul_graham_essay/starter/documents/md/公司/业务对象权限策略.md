# 业务对象权限策略

## Controller

hzero-modeler

* org.hzero.modeler.business.api.controller.v1.BusinessObjectPermissionGroupController
* org.hzero.modeler.business.api.controller.v1.BusinessObjectPermissionGroupSiteController
* org.hzero.modeler.business.api.controller.v1.BusinessObjectPermissionGroupTenantController
* org.hzero.modeler.business.api.controller.v1.BusinessObjectPermissionGroupTenantSiteController

## 表

| 名称                     | 说明                                       |
| ------------------------ | ------------------------------------------ |
| hmde_bo_pms_data_filter  | 业务对象权限策略数据范围控制（过滤条件）表 |
| hmde_bo_pms_group        | 业务对象权限策略表                         |
| hmde_bo_pms_group_role   | 业务对象权限策略角色分配表                 |
| hmde_bo_pms_group_tenant | 业务对象权限策略租户分配表                 |

## 同步到数据对象

### 发布业务对象时

org.hzero.modeler.business.app.service.BusinessObjectPermissionGroupService#syncToDataObjectCondition

入参：发布时的租户ID和业务对象编码

1. 查询业务对象；
2. 判断业务对象是不是单业务对象；
3. 查询待同步的目标数据对象模型，以 业务对象编码 == 数据对象主模型编码 的关系，和 MASTER_FLAG == 1 作为查询条件；
4. 如果以租户角色进行操作，则在此阶段过滤数据对象主模型，只允许同步到当前租户的数据对象；
5. 查询业务对象权限策略四张表的数据；
6. 查询数据对象过滤条件四张表的数据；
7. 取消发布数据对象过滤条件（删除发布表数据）；
8. 比对数据对象过滤条件头表和业务对象权限策略头表数据，并进行增/删/改；
9. 在修改的操作中，比对另外三张行表的数据，除了明细表为删除后重新生成以外，进行增/删/改操作；
10. 在上述两步里，收集增/改的数据，用于发布；
11. 执行发布；
12. 清数据对象缓存。

### 保存租户或角色分配时

org.hzero.modeler.business.domain.repository.BusinessObjectPermissionGroupRepository#syncAssignToDataObjectCondition

入参：业务对象租户 ID、业务对象编码、修改的权限策略 ID

1. 根据业务对象编码，查询所有该业务对象生成的数据对象主模型；
2. 查询业务对象权限策略头表数据，判断是否存在。若不存在，则不进行任何操作；
3. 查询业务对象权限策略租户和角色授权，如果以租户角色进行操作，则只查询当前租户数据；
4. 同步授权表数据；
5. 取消发布，并重新发布；
6. 清数据对象缓存。
